# Client Authenticated HTTPS

*HTTPS communication authenticated using client as well as server SSL certificates*

This library is useful when you want to guarantee that only authorised clients can communicate with a server using HTTPS encryption

Generate keys for both the server and the clients for encryption and authentication.

This library is open source under the MIT license and has good coverage with unit tests. Please feel free to contribute over on GitHub.

## Setting up keys

Create a directory named `cahkeys` to hold server and client keys. A good place to put this directory is in your project root directory.

### Generating a server key

There can be only 1 server key. Generate the server key using the command:

```
npx client-authenticated-https create-key --server --keydir /path/to/cahkeys --name <server-hostname>
```

The value `<server-hostname>` passed to `--name` must match the host name the clients will use to connect to the server or a connection will not be established. At this point in time, `<server-hostname>` can only be a single, fixed value. Wildcards or alternative names are not currently supported. If you omit `--name` the default name '`localhost`' will be used.

Take a look in your `cahkeys` directory - you will now see `server.cahkey`

```
$ ls -la /path/to/cahkeys/
total 16
drwxr-xr-x  3 tom  staff    96  4 Sep 22:13 .
drwxr-xr-x  9 tom  staff   288  4 Sep 21:48 ..
-rw-r--r--  1 tom  staff  7857  4 Sep 21:09 server.cahkey
```

### Generating client keys

There can be as many client keys as you require. Generate a client key using the command:

```
npx client-authenticated-https create-key --keydir /path/to/cahkeys --name client
```

If you omit `--keydir` it will search for the directory `cahkeys` by progressing back through the directory tree from the `client-authenticated-https` directory inside the `node_modules`. If you placed `cahkeys` in your project root directory it should be found automatically if you can omit `--keydir`

If you omit `--name` the default name '`client`' will be used. It is not required that the value `<client-name>` passed to `--name` matches any of the network credentials of the client to establish a connection.

**NB: The server key is effectively the master key. All client keys are generated from the server key. If you regenerate the server key you will need to regenerate all the client keys!!! For this reason it may be worth making a secure backup of the server key.**

Take a look in your `cahkeys` directory - you will now see `client.cahkey`

```
$ ls -la cahkeys/
total 32
drwxr-xr-x  4 tom  staff   128  4 Sep 21:10 .
drwxr-xr-x  9 tom  staff   288  4 Sep 21:48 ..
-rw-r--r--  1 tom  staff  5372  4 Sep 21:10 client.cahkey
-rw-r--r--  1 tom  staff  7857  4 Sep 21:09 server.cahkey
```

You can generate as many client keys as you wish, however if you have more than 1 you will need to specify which to use when making a request.

## API

The API extends Node's `https` with 2 methods overridden: `.request()` and `.createServer()`. Both these methods have the same signature as they do in the `https` library, however an important difference is that they are `async` methods.

See the node documentation for information about how to use these methods:

* https://nodejs.org/api/https.html#https_https_request_options_callback
* https://nodejs.org/api/https.html#https_https_createserver_options_requestlistener

## Example code

### Example server

Let's review migrating a server written using `https` to use `clientAuthenticatedKeys`:

```javascript
const https = require('https')

exports = () => {
  https.createServer(
    {
      cert: fs.readFileSync('/path/to/cert/fullchain.pem'),
      key: fs.readFileSync('/path/to/cert/privkey.pem')
    },
    (req, res) => {
      …
    }
  ).listen(443)
}
```

The following changes need to be made:

* Require `client-authenticated-https` instead of `https`
* `await` on `.createServer()` before chaining the returned value to `.listen(443)`
* Update the enclosing function to use `async` (or alternativly use `clientAuthenticatedHttps.createServer()` as a promise)
* Remove SSL options related to `cert`, `key` and `ca` as these are replaced by the keys generated by `npx client-authenticated-https create-key`

```javascript
const clientAuthenticatedHttps = require('client-authenticated-https')

exports = async () => {
  (await clientAuthenticatedHttps.createServer(
    (req, res) => {
      …
    }
  )).listen(443)
}
```

### Example client

Let's review migrating a client request written using `https` to use `clientAuthenticatedKeys`:

```javascript
const https = require('https')

exports = () => {
  const req = https.request(
    {
      url: 'https://localhost/',
      …
    },
    (res) => { … }
  )

  req.write(postData)
  req.end()
}
```

The following changes need to be made:

* Require `client-authenticated-https` instead of `https`
* `await` on `.request()` before calling further methods on the returned request object
* Update the enclosing function to use `async` (or alternativly use `clientAuthenticatedHttps.request()` as a promise)
* Optionally specify the name of the cahkey to use to make the request. This is useful if there is more than 1 client key in your `cahkeys` directory. Do not include the `.cahkey` file extension. A cahkey can also be defined by setting the environment variable `CAH_KEY_NAME` (again, without extension).

```javascript
const clientAuthenticatedHttps = require('client-authenticated-https')

exports = async () => {
  const req = await clientAuthenticatedHttps.request(
    {
      url: 'https://localhost/',
      cahkey: 'my-special-key',
      …
    },
    (res) => { … }
  )

  req.write(postData)
  req.end()
}
```

### Further examples

Look in `./example/` for a working example of a server and client

## Specifying a custom `cahkeys` directory

The `cahkeys` directory is located by prgressing back through the filesystem from the `client-authenticated-https` directory until a `cahkeys` directory is found. You can specify a directory at an alternative location by supplying a path to the directory in the env var `CAH_KEY_DIR`.
