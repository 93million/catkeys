/* global jest test expect */

const checkServerIdentity = require('./checkServerIdentity')
const tls = require('tls')

jest.mock('tls')

const mockCertSigFailErr = { code: 'CERT_SIGNATURE_FAILURE' }
const mockAltNameInvalidErr = { code: 'ERR_TLS_CERT_ALTNAME_INVALID' }
const mockHost = 'localhost'
const mockCert = '__mock-cert__'

test(
  'it should return any errors generated by tls.checkServerIdentity',
  () => {
    tls.checkServerIdentity.mockReturnValueOnce(mockCertSigFailErr)

    expect(checkServerIdentity(mockHost, mockCert)).toEqual(mockCertSigFailErr)
  }
)

test(
  'it should return errors with the code ERR_TLS_CERT_ALTNAME_INVALID',
  () => {
    tls.checkServerIdentity.mockReturnValueOnce(mockAltNameInvalidErr)

    expect(checkServerIdentity(mockHost, mockCert))
      .toEqual(mockAltNameInvalidErr)
  }
)

test(
  // eslint-disable-next-line max-len
  'it should not return errors with the code ERR_TLS_CERT_ALTNAME_INVALID when option cahIgnoreMismatchedHostName is true',
  () => {
    tls.checkServerIdentity.mockReturnValueOnce(mockAltNameInvalidErr)

    expect(checkServerIdentity(
      mockHost,
      mockCert,
      { cahIgnoreMismatchedHostName: true }
    ))
      .toBe(undefined)
  }
)

test(
  'it should return undefined when tls.checkServerIdentity returns undefined',
  () => {
    tls.checkServerIdentity.mockReturnValueOnce(undefined)

    expect(checkServerIdentity(mockHost, mockCert)).toBe(undefined)
  }
)
